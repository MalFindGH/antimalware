$ErrorActionPreference = "SilentlyContinue"

$detectionAmount = 0
$trusted = 0

$hashes = @{
    "8c290c1d312679d870a02520e1a57c48" = "Android.Trojan.InfoStealer.AAS"
    "caf5b9f1ad073a4108af16cccf68cfc9" = "Trojan.GenericKDZ.98448"

}

$databases = @{
    "1364830x00000000014700000.dmp" = "Trojan.U.GuLoader.bot"
    }


$whitelist = @(
    "732a0f9adfb6378f2cfaa8c708e1c663",
    "732a0f9adfb6378f2cfaa8c708e1c662",

)

function Get-FormattedSize($sizeInBytes) {
    $sizeInGB = $sizeInBytes / 1GB
    $sizeInMB = $sizeInBytes / 1MB
    $sizeInKB = $sizeInBytes / 1KB

    if ($sizeInGB -ge 1) {
        return "{0:N2} GB" -f $sizeInGB
    }
    elseif ($sizeInMB -ge 1) {
        return "{0:N2} MB" -f $sizeInMB
    }
    elseif ($sizeInKB -ge 1) {
        return "{0:N2} KB" -f $sizeInKB
    }
    else {
        return "{0:N2} Bytes" -f $sizeInBytes
    }
}

function Set-WindowTitle($title) {
    $host.UI.RawUI.WindowTitle = $title
}

function Get-FileMD5Hash($filePath) {
    $hasher = [System.Security.Cryptography.MD5]::Create()
    $fileBytes = [System.IO.File]::ReadAllBytes($filePath)
    $hashBytes = $hasher.ComputeHash($fileBytes)

    $hash = [System.BitConverter]::ToString($hashBytes).Replace('-', '')
    return $hash
}

function IsMicrosoftSigned($filePath) {
#     $cert = Get-AuthenticodeSignature -FilePath $filePath -ErrorAction SilentlyContinue
#     $trustedSigners = @(
#         "Microsoft Corporation",
#         "AVG Technologies USA, LLC",
#        "Avast Software s.r.o.",
#	"C2RService",
#	"Tim Kosse"
#    )
#
#    if ($cert) {
#        foreach ($trustedSigner in $trustedSigners) {
#            if ($cert.SignerCertificate.Issuer -like "*$trustedSigner*") {
#                return $true
#            }
#        }
#    }
#    return $false
}

 function Scan-Directory($path) {

    $flaggedFiles = @()  # Store flagged files

    $files = Get-ChildItem -Path $path -File -ErrorAction SilentlyContinue

    foreach ($file in $files) {

        $filePath = $file.FullName
        $fileSize = Get-FormattedSize -sizeInBytes $file.Length
        $formattedSize = Get-FormattedSize -sizeInBytes $fileSize
        $title = "Scanning $filePath - Size: ${fileSize}"
        Set-WindowTitle -title $title

        # Check file content for specific strings
        $stringsToCheck = @{
            'http://kukutrustnet888.info/home.gif' = 'Win32/Kashu.E'
	    'http://kukutrustnet987.info/home.gif' = 'Malware:Win32/km_2a8b727.None'
	    'http://kukutrustnet777.info/home.gif' = 'Trojan.SalityStub.F'

        }


        $fileContent = Get-Content -Path $filePath -Raw


        $detected = $false


        foreach ($string in $stringsToCheck.Keys) {
            if ($fileContent -like "*$string*") {
                $detection = $stringsToCheck[$string]
                if ($flaggedFiles -notcontains "$filePath - $detection") {
                    $flaggedFiles += "$filePath - $detection"
                    Write-Output "Behavior shield: $filePath - $detection"
                    $detected = $true
		    # Set the path to the sound file
		    $soundFilePath = "C:\Windows\Media\notify.wav"
		    # Create a SoundPlayer object
		    $soundPlayer = New-Object System.Media.SoundPlayer
		    $soundPlayer.SoundLocation = $soundFilePath
		    # Play the sound
		    $soundPlayer.Play()
		    $detectionAmount += 1
                }
            }
        }


        if (-not $flagged) {
            # Write-Output "File not flagged: $filePath"
        }

        $hash = Get-FileMD5Hash -filePath $filePath
        if ($whitelist -contains $hash) {
            # Write-Output "Whitelisted hash found! File: $filePath, MD5 Hash: $hash"
	    $trusted += 1
            continue
        }

        if ($hashes.ContainsKey($hash)) {
            Write-Output "File: $filePath, MD5: $hash, $($hashes[$hash])"
        }

        foreach ($database in $databases.Keys) {
            if ($file.Name -like "*$database*") {
                Write-Output "$database! File: $filePath, Result: $($databases[$database])"
            }
        }

    }


    $directories = Get-ChildItem -Path $path -Directory -ErrorAction SilentlyContinue
    foreach ($directory in $directories) {
        $directoryPath = $directory.FullName
        if ($excludedFolders -contains $directoryPath) {
            continue
        }
        Scan-Directory -path $directoryPath
    }

}
    

cls

echo "Please read and review the following terms of conditions and license agreement listed below:

Terms:
a) Commercial use: Please follow per the condition that most versions of this product come as not allowed for commercial use, but some versions do.

b) Commercial use, extended: Selling of this product in any way is not allowed per the fact that the original product is free but may be packaged in premium versions, which are still subject to this section of the license agreement.

c) Third-party site use: Copies of old, outdated, or any versions in any or all third-party sites is strictly prohibited by this license agreement. Third-party copies of this product should be reported to the owner and producer of this product.

d) Third-party site use, extended: Furthermore, modified versions of this product are also not allowed on third-party sites per this license agreement. Branded repackaging of this product is also strictly prohibited and may be reported to the author and producer of this product, which may result in serious penalties.

e) Signature use: In order for other companies to use signatures from this product, those companies must have obtained explicit permission from the producer and author of this product.

f) Signature use, extended: This process will involve contacting the author and producer of the product and will require credits to the author and producer in order for the company to be accepted and allowed to use this product's malware signatures.

g) Credits and acknowledgements: This product uses many signature names of several antiviruses, but not signature contents. This retains the ownership of these signatures by the author and producer of this product.

Press the enter key if you agree to the terms of service. Press the X button on this program to close it if you do not agree to the terms of service."

pause

cls

Write-Output ""
Write-Output "
Version information:
SOS Version: v1.0
Commercial use allowed: No
Premium version: Yes

Signature information:
FN Signatures: 125
Hash Signatures: 124
Generic signatures: 114
Whitelisted hashes: 39"

echo

echo "Scanning external drives..."
Scan-Directory -path "Q:\"
Scan-Directory -path "W:\"
Scan-Directory -path "E:\"
Scan-Directory -path "R:\"
Scan-Directory -path "T:\"
Scan-Directory -path "Y:\"
Scan-Directory -path "U:\"
Scan-Directory -path "I:\"
Scan-Directory -path "O:\"
Scan-Directory -path "P:\"
Scan-Directory -path "A:\"
Scan-Directory -path "S:\"
Scan-Directory -path "D:\"
Scan-Directory -path "F:\"
Scan-Directory -path "G:\"
Scan-Directory -path "H:\"
Scan-Directory -path "J:\"
Scan-Directory -path "K:\"
Scan-Directory -path "L:\"
Scan-Directory -path "Z:\"
Scan-Directory -path "X:\"
Scan-Directory -path "V:\"
Scan-Directory -path "B:\"
Scan-Directory -path "N:\"
Scan-Directory -path "M:\"
echo "Scanning file system..."
Scan-Directory -path "C:\"
Write-Output ""
Write-Output "
Total detections: $detectionAmount
"

Set-WindowTitle -title "PowerShell"
